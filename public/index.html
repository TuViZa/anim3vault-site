<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Anim3Vault</title>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#000; color:white; overflow-x:hidden; }
    header { position:sticky; top:0; background:#111; padding:10px; text-align:center; font-size:1.8em; z-index:1000; }
    .nav-buttons { display:flex; justify-content:center; background:#222; flex-wrap:wrap; }
    .nav-buttons .btn { color:white; padding:10px; margin:5px; background:#444; border-radius:8px; cursor:pointer; }
    .nav-buttons .btn.active { background:#f0f; color:black; }
    .screen { display:none; padding:10px; }
    .screen.active { display:block; }
    #anim3 { background:#18112b; }
    #donghua { background:#12243b; }
    #news { background:#2b1414; }
    .scroll-row { display:flex; overflow-x:auto; gap:16px; padding-bottom:10px; }
    .vertical-scroll { display:flex; flex-direction:column; gap:16px; max-height:75vh; overflow-y:auto; }
    .group-heading { background:black; color:white; padding:10px 16px; font-size:1.2em; margin:20px 0 10px; }
    .group-heading.red { background:red; color:black; }
    .video-card { background:#1a1a1a; border-radius:10px; width:280px; flex-shrink:0; overflow:hidden; }
    .video-thumb img { width:100%; cursor:pointer; aspect-ratio:16/9; object-fit:cover; }
    .video-title { padding:10px; text-align:center; }
    .modal { display:none; position:fixed; top:0;left:0;width:100vw;height:100vh; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; }
    .modal-content { background:#111; padding:15px; border-radius:8px; max-width:900px; max-height:90vh; overflow-y:auto; }
    .modal-content iframe { width:100%; height:50vw; max-height:450px; }
    .close-btn { float:right; font-size:24px; color:#f0f; cursor:pointer; }
    .auth-buttons { position:absolute; right:20px; top:10px; }
    .auth-buttons button { margin-left:8px; padding:6px 10px; background:#444; color:white; border:none; border-radius:6px; cursor:pointer; }
    .auth-form { background:#111; padding:15px; max-width:300px; margin:10px auto; border-radius:10px; }
    .auth-form input { width:100%; margin-bottom:10px; padding:8px; border:none; border-radius:4px; }
    @media(max-width:768px){ .modal-content iframe{ height:56vw } }
  </style>
</head>
<body>
  <header>Anim3Vault
    <div class="auth-buttons">
      <button id="loginBtn" onclick="toggleAuthForm('login')">Login</button>
      <button id="signupBtn" onclick="toggleAuthForm('signup')">Signup</button>
      <button id="logoutBtn" onclick="logout()" style="display:none">Logout</button>
    </div>
  </header>

  <div class="auth-form" id="authForm" style="display:none;">
    <div id="authTitle">Login</div>
    <input id="authUsername" placeholder="Username" />
    <input type="password" id="authPassword" placeholder="Password" />
    <button onclick="submitAuth()">Submit</button>
    <div id="authMessage" style="color:red;"></div>
  </div>

  <div class="nav-buttons">
    <a class="btn active" onclick="showScreen('anim3', this)">Anim3</a>
    <a class="btn" onclick="showScreen('donghua', this)">Donghua</a>
    <a class="btn" onclick="showScreen('news', this)">News</a>
  </div>

  <div id="anim3" class="screen active">
    <div class="loading">Loading Anim3...</div>
    <div id="anim3-videos"></div>
  </div>

  <div id="donghua" class="screen">
    <div class="loading">Loading Donghua...</div>
    <div id="donghua-videos"></div>
  </div>

  <div id="news" class="screen">
    <div class="loading">Loading News...</div>
    <div id="news-videos" class="vertical-scroll"></div>
  </div>

  <div id="videoModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h2 id="modal-title"></h2>
      <div id="modal-video"></div>
      <p id="modal-description"></p>
      <div id="modal-channel"></div>
      <div id="modal-comments"></div>
    </div>
  </div>
<script>
  const pageTokens = { anim3: '', donghua: '', news: '' };
  const loadedVideos = { anim3: new Set(), donghua: new Set(), news: new Set() };

  function showScreen(id, btn) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-buttons .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  async function fetchVideos(type) {
    const res = await fetch(`/api/fetch-videos?type=${type}&pageToken=${pageTokens[type]}`);
    const data = await res.json();
    pageTokens[type] = data.nextPage || '';
    return data;
  }

  function createCard(video) {
    const card = document.createElement('div');
    card.className = 'video-card';
    const vid = video.snippet.resourceId.videoId;
    const thumbnail = video.snippet.thumbnails.medium.url;
    card.innerHTML = `
      <div class="video-thumb">
        <img src="${thumbnail}" alt="${video.snippet.title}" />
      </div>
      <div class="video-title">${video.snippet.title}</div>
    `;
    card.querySelector('img').onclick = () => showModal(video);
    return card;
  }

  async function loadGrouped(section, containerId) {
    const container = document.getElementById(containerId);
    const loading = container.previousElementSibling;
    if (loading) loading.textContent = "Loading...";
    const data = await fetchVideos(section);
    if (loading) loading.style.display = 'none';

    container.innerHTML = '';

    // 1. Add LATEST section (not for news)
    if (section !== 'news' && data.latest?.length) {
      const latestHeading = document.createElement('div');
      latestHeading.className = 'group-heading';
      latestHeading.style.background = 'red';
      latestHeading.style.color = 'black';
      latestHeading.textContent = 'LATEST';

      const latestRow = document.createElement('div');
      latestRow.className = 'scroll-row';

      data.latest.forEach(v => {
        const vid = v.snippet.resourceId.videoId;
        if (!loadedVideos[section].has(vid)) {
          loadedVideos[section].add(vid);
          latestRow.appendChild(createCard(v));
        }
      });

      container.appendChild(latestHeading);
      container.appendChild(latestRow);
    }

    // 2. Sorted groups for donghua only
    if (section === 'donghua' && data.grouped) {
  Object.entries(data.grouped)
    .map(([name, vids]) => {
      const fresh = vids.filter(v => !loadedVideos[section].has(v.snippet.resourceId.videoId));
      const latestTime = fresh.length ? Math.max(...fresh.map(v => new Date(v.snippet.publishedAt).getTime())) : 0;
      return { name, vids: fresh, latestTime };
    })
    .filter(g => g.vids.length > 0) // ← Ensure only groups with videos are shown
    .sort((a, b) => b.latestTime - a.latestTime)
    .forEach(group => {
      const heading = document.createElement('div');
      heading.className = 'group-heading';
      heading.textContent = group.name;

      const wrapper = document.createElement('div');
      wrapper.className = 'scroll-row';

      group.vids.forEach(v => {
        const vid = v.snippet.resourceId.videoId;
        loadedVideos[section].add(vid);
        wrapper.appendChild(createCard(v));
      });

      container.appendChild(heading);
      container.appendChild(wrapper);
    });
}


    // 3. Mixed section
    const mixed = (data.mixed || []).filter(v => !loadedVideos[section].has(v.snippet.resourceId.videoId));
    if (mixed.length) {
      const heading = document.createElement('div');
      heading.className = 'group-heading';
      heading.textContent = 'Mixed';

      const wrapper = document.createElement('div');
      wrapper.className = section === 'news' ? 'vertical-scroll' : 'scroll-row';

      mixed.forEach(v => {
        const vid = v.snippet.resourceId.videoId;
        loadedVideos[section].add(vid);
        wrapper.appendChild(createCard(v));
      });

      container.appendChild(heading);
      container.appendChild(wrapper);
    }
  }

  function toggleAuthForm(mode) {
    document.getElementById("authForm").style.display = "block";
    document.getElementById("authTitle").textContent = mode === "signup" ? "Signup" : "Login";
    document.getElementById("authForm").setAttribute("data-mode", mode);
    document.getElementById("authMessage").textContent = '';
  }

  function submitAuth() {
    const mode = document.getElementById("authForm").getAttribute("data-mode");
    const username = document.getElementById("authUsername").value.trim();
    const password = document.getElementById("authPassword").value;
    if (!username || !password) return showMsg("Fill all fields");
    const users = JSON.parse(localStorage.getItem("users") || "{}");
    if (mode === "signup") {
      if (users[username]) return showMsg("User already exists");
      users[username] = password;
    } else {
      if (users[username] !== password) return showMsg("Invalid credentials");
    }
    localStorage.setItem("users", JSON.stringify(users));
    localStorage.setItem("loggedInUser", username);
    hideAuthUI();
  }

  function showMsg(msg) {
    document.getElementById("authMessage").textContent = msg;
  }

  function hideAuthUI() {
    document.getElementById("authForm").style.display = "none";
    document.getElementById("loginBtn").style.display = "none";
    document.getElementById("signupBtn").style.display = "none";
    document.getElementById("logoutBtn").style.display = "inline-block";
  }

  function logout() {
    localStorage.removeItem("loggedInUser");
    document.getElementById("loginBtn").style.display = "inline-block";
    document.getElementById("signupBtn").style.display = "inline-block";
    document.getElementById("logoutBtn").style.display = "none";
  }

  function showModal(video) {
    const vid = video.snippet.resourceId.videoId;
    document.getElementById("modal-title").textContent = video.snippet.title;
    document.getElementById("modal-video").innerHTML = `
      <iframe 
        src="https://www.youtube.com/embed/${vid}?autoplay=1"
        frameborder="0"
        allow="fullscreen; autoplay"
        allowfullscreen
      ></iframe>
    `;
    document.getElementById("modal-description").textContent = video.snippet.description;
    document.getElementById("modal-channel").innerHTML = `<a href="https://www.youtube.com/channel/${video.snippet.channelId}" target="_blank">Visit ${video.snippet.channelTitle}'s channel</a>`;
    document.getElementById("modal-comments").innerHTML = `<a href="https://www.youtube.com/watch?v=${vid}#comments" target="_blank">View Comments on YouTube</a>`;
    document.getElementById("videoModal").style.display = "flex";
  }

  function closeModal(event) {
    if (!event || event.target.id === 'videoModal' || event.target.classList.contains('close-btn')) {
      document.getElementById("videoModal").style.display = "none";
      document.getElementById("modal-video").innerHTML = '';
    }
  }

  window.onload = () => {
    if (localStorage.getItem("loggedInUser")) hideAuthUI();
    loadGrouped("anim3", "anim3-videos");
    loadGrouped("donghua", "donghua-videos");
    loadGrouped("news", "news-videos");
  };
</script>

</body>
</html>
