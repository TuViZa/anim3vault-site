<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Anim3Vault</title>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#000; color:white; overflow-x:hidden; }
    header { position:sticky; top:0; background:#111; padding:10px; text-align:center; font-size:1.8em; z-index:1000; }
    .nav-buttons { display:flex; justify-content:center; background:#222; flex-wrap:wrap; }
    .nav-buttons .btn { color:white; padding:10px; margin:5px; background:#444; border-radius:8px; cursor:pointer; }
    .nav-buttons .btn.active { background:#f0f; color:black; }
    .screen { display:none; padding:10px; }
    .screen.active { display:block; }
    #anim3 { background:#18112b; }
    #donghua { background:#12243b; }
    #news { background:#2b1414; }
    .scroll-row { display:flex; overflow-x:auto; gap:16px; padding-bottom:10px; }
    .vertical-scroll { display:flex; flex-direction:column; gap:16px; max-height:75vh; overflow-y:auto; }
    .group-heading { background:black; color:white; padding:10px 16px; font-size:1.2em; margin:20px 0 10px; }
    .group-heading.red { background:red; color:black; }
    .video-card { background:#1a1a1a; border-radius:10px; width:280px; flex-shrink:0; overflow:hidden; }
    .video-thumb img { width:100%; cursor:pointer; aspect-ratio:16/9; object-fit:cover; }
    .video-title { padding:10px; text-align:center; }
    .modal { display:none; position:fixed; top:0;left:0;width:100vw;height:100vh; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:9999; }
    .modal-content { background:#111; padding:15px; border-radius:8px; max-width:900px; width:90vw; }
    .modal-content iframe, #yt-player { width:100%; aspect-ratio:16/9; }
    .close-btn { float:right; font-size:24px; color:#f0f; cursor:pointer; }
    .auth-buttons { position:absolute; right:20px; top:10px; }
    .auth-buttons button { margin-left:8px; padding:6px 10px; background:#444; color:white; border:none; border-radius:6px; cursor:pointer; }
    .auth-form { background:#111; padding:15px; max-width:300px; margin:10px auto; border-radius:10px; }
    .auth-form input { width:100%; margin-bottom:10px; padding:8px; border:none; border-radius:4px; }
    .yt-controls { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; align-items:center; justify-content:center; }
    .yt-controls button, .yt-controls select { padding:6px 10px; background:#333; color:white; border:none; border-radius:4px; cursor:pointer; }
    .yt-controls span { margin:0 8px; font-weight:bold; }
  </style>
</head>
<body>
  <header>Anim3Vault
    <div class="auth-buttons">
      <button id="loginBtn" onclick="toggleAuthForm('login')">Login</button>
      <button id="signupBtn" onclick="toggleAuthForm('signup')">Signup</button>
      <button id="logoutBtn" onclick="logout()" style="display:none">Logout</button>
    </div>
  </header>

  <div class="auth-form" id="authForm" style="display:none;">
    <div id="authTitle">Login</div>
    <input id="authUsername" placeholder="Username" />
    <input type="password" id="authPassword" placeholder="Password" />
    <button onclick="submitAuth()">Submit</button>
    <div id="authMessage" style="color:red;"></div>
  </div>

  <div class="nav-buttons">
    <a class="btn" onclick="showScreen('anim3', this)">Anim3</a>
    <a class="btn active" onclick="showScreen('donghua', this)">Donghua</a>
    <a class="btn" onclick="showScreen('news', this)">News</a>
  </div>

  <div id="anim3" class="screen">
    <div class="loading">Loading Anim3...</div>
    <div id="anim3-videos"></div>
  </div>

  <div id="donghua" class="screen active">
    <div class="loading">Loading Donghua...</div>
    <div id="donghua-videos"></div>
  </div>

  <div id="news" class="screen">
    <div class="loading">Loading News...</div>
    <div id="news-videos"></div>
  </div>

  <div id="videoModal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h2 id="modal-title"></h2>
      <div id="modal-video"></div>
      <p id="modal-description"></p>
      <div id="modal-channel"></div>
      <div id="modal-comments"></div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
<script>
let ytPlayer, currentVideoId = null;
const loadedVideos = { anim3: new Set(), donghua: new Set(), news: new Set() };

function showScreen(id, btn) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-buttons .btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

async function fetchGrouped(type) {
  try {
    const res = await fetch(`/api/fetch-grouped?type=${type}`);
    return await res.json();
  } catch (err) {
    console.error('Error fetching grouped data:', err);
    return {};
  }
}

async function fetchLatest(type) {
  try {
    const res = await fetch(`/api/fetch-latest?type=${type}`);
    return await res.json();
  } catch (err) {
    console.error('Error fetching latest data:', err);
    return {};
  }
}

function createCard(video) {
  const card = document.createElement('div');
  card.className = 'video-card';
  const vid = video.snippet.resourceId.videoId;
  const thumbnail = video.snippet.thumbnails.medium.url;
  const title = video.snippet.title;
  card.innerHTML = `
    <div class="video-thumb">
      <img src="${thumbnail}" alt="Thumbnail for ${title}" />
    </div>
    <div class="video-title">${title}</div>
  `;
  card.querySelector('img').onclick = () => showModal(video);
  return card;
}

async function loadGrouped(section, containerId) {
  const container = document.getElementById(containerId);
  const loading = container.previousElementSibling;
  if (loading) loading.textContent = "Loading...";

  const [latestData, groupedData] = await Promise.all([
    fetchLatest(section),
    fetchGrouped(section)
  ]);

  if (loading) loading.style.display = 'none';
  container.innerHTML = '';

  // LATEST
  if (section !== 'news' && latestData?.latest?.length) {
    const latestHeading = document.createElement('div');
    latestHeading.className = 'group-heading red';
    latestHeading.textContent = 'LATEST';
    const latestRow = document.createElement('div');
    latestRow.className = 'scroll-row';
    latestData.latest.forEach(v => latestRow.appendChild(createCard(v)));
    container.appendChild(latestHeading);
    container.appendChild(latestRow);
  }

  // DONGHUA GROUPED
  if (section === 'donghua' && groupedData.grouped) {
    const sortedGroups = Object.entries(groupedData.grouped).sort((a, b) => {
      const latestA = new Date(a[1][0]?.snippet?.publishedAt || 0).getTime();
      const latestB = new Date(b[1][0]?.snippet?.publishedAt || 0).getTime();
      return latestB - latestA;
    });

    for (const [name, vids] of sortedGroups) {
      const fresh = vids.filter(v => !loadedVideos[section].has(v.snippet.resourceId.videoId));
      if (!fresh.length) continue;

      const heading = document.createElement('div');
      heading.className = 'group-heading';
      heading.textContent = name;

      const wrapper = document.createElement('div');
      wrapper.className = 'scroll-row';

      fresh.forEach(v => {
        const vid = v.snippet.resourceId.videoId;
        loadedVideos[section].add(vid);
        wrapper.appendChild(createCard(v));
      });

      container.appendChild(heading);
      container.appendChild(wrapper);
    }
  }

  // MIXED
  const mixed = (groupedData.mixed || []).filter(v => !loadedVideos[section].has(v.snippet.resourceId.videoId));
  if (mixed.length) {
    const heading = document.createElement('div');
    heading.className = 'group-heading';
    heading.textContent = 'Mixed';

    const wrapper = document.createElement('div');
    wrapper.className = section === 'news' ? 'vertical-scroll' : 'scroll-row';

    if (section === 'news') {
      wrapper.style.alignItems = 'flex-end';
      wrapper.style.display = 'flex';
      wrapper.style.flexDirection = 'column';
    }

    mixed.forEach(v => {
      loadedVideos[section].add(v.snippet.resourceId.videoId);
      wrapper.appendChild(createCard(v));
    });

    container.appendChild(heading);
    container.appendChild(wrapper);
  }
}

// Custom YouTube Modal
function showModal(video) {
  currentVideoId = video.snippet.resourceId.videoId;
  document.getElementById("modal-title").textContent = video.snippet.title;
  document.getElementById("modal-description").textContent = video.snippet.description;
  document.getElementById("modal-channel").innerHTML = `<a href="https://www.youtube.com/channel/${video.snippet.channelId}" target="_blank">Visit ${video.snippet.channelTitle}'s channel</a>`;
  document.getElementById("modal-comments").innerHTML = `<a href="https://www.youtube.com/watch?v=${currentVideoId}#comments" target="_blank">View Comments on YouTube</a>`;
  document.getElementById("modal-video").innerHTML = `<div class="yt-wrapper">
  <div id="yt-player"></div>
  <div class="yt-controls">
    <button onclick="ytPlayer.playVideo()">‚ñ∂</button>
    <button onclick="ytPlayer.pauseVideo()">‚è∏</button>
    <button onclick="ytPlayer.seekTo(ytPlayer.getCurrentTime() - 10, true)">‚è™ 10s</button>
    <button onclick="ytPlayer.seekTo(ytPlayer.getCurrentTime() + 10, true)">10s ‚è©</button>
    <button onclick="toggleMute()">üîä</button>
    <span id="yt-time">0:00 / 0:00</span>
    <button onclick="toggleCaptions()">CC</button>
    <select onchange="setPlaybackQuality(this.value)">
      <option disabled selected>Quality</option>
      <option value="small">240p</option>
      <option value="medium">360p</option>
      <option value="large">480p</option>
      <option value="hd720">720p</option>
      <option value="hd1080">1080p</option>
    </select>
    <select onchange="setPlaybackRate(this.value)">
      <option disabled selected>Speed</option>
      <option value="0.25">0.25x</option>
      <option value="0.5">0.5x</option>
      <option value="1" selected>1x</option>
      <option value="1.5">1.5x</option>
      <option value="2">2x</option>
    </select>
    <button onclick="ytPlayer.getIframe().requestFullscreen()">‚õ∂</button>
  </div>
</div>
`;

  document.getElementById("videoModal").style.display = "flex";
  if (screen.orientation && screen.orientation.lock) screen.orientation.lock("landscape").catch(() => {});

  setTimeout(() => {
    ytPlayer = new YT.Player("yt-player", {
  videoId: currentVideoId,
  events: { onReady: updateTime, onStateChange: updateTime },
  playerVars: {
    autoplay: 1,
    controls: 0,         // üëà hide default controls
    modestbranding: 1,   // üëà hide YouTube logo
    rel: 0,              // üëà no related videos
    showinfo: 0,         // üëà hide video info (legacy; may be ignored)
    fs: 0,               // üëà hide fullscreen button (optional)
    iv_load_policy: 3,   // üëà hide annotations
    cc_load_policy: 0,   // üëà captions off by default
    disablekb: 1         // üëà disable keyboard controls
  }
});
  }, 100);
}

function updateTime() {
  clearInterval(window.timeUpdater);
  window.timeUpdater = setInterval(() => {
    if (ytPlayer && ytPlayer.getDuration) {
      const cur = formatTime(ytPlayer.getCurrentTime());
      const total = formatTime(ytPlayer.getDuration());
      document.getElementById("yt-time").textContent = `${cur} / ${total}`;
    }
  }, 1000);
}

function formatTime(s) {
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60).toString().padStart(2, '0');
  return `${m}:${sec}`;
}

function toggleMute() {
  if (!ytPlayer) return;
  ytPlayer.isMuted() ? ytPlayer.unMute() : ytPlayer.mute();
}

function toggleCaptions() {
  if (!ytPlayer) return;
  const hasCaptions = ytPlayer.getOptions('captions')?.length;
  hasCaptions ? ytPlayer.setOption('captions', 'track', null) : ytPlayer.loadModule('captions');
}

function setPlaybackRate(rate) {
  ytPlayer.setPlaybackRate(parseFloat(rate));
}

function setPlaybackQuality(q) {
  ytPlayer.setPlaybackQuality(q);
}

function closeModal(event) {
  if (!event || event.target.id === 'videoModal' || event.target.classList.contains('close-btn')) {
    if (ytPlayer) ytPlayer.destroy();
    ytPlayer = null;
    document.getElementById("modal-video").innerHTML = '';
    document.getElementById("videoModal").style.display = "none";
    clearInterval(window.timeUpdater);
  }
}

// Auth
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function submitAuth() {
  const mode = document.getElementById("authForm").getAttribute("data-mode");
  const username = document.getElementById("authUsername").value.trim();
  const password = document.getElementById("authPassword").value;
  if (!username || !password) return showMsg("Fill all fields");

  const users = JSON.parse(localStorage.getItem("users") || "{}");
  const hashed = await hashPassword(password);

  if (mode === "signup") {
    if (users[username]) return showMsg("User already exists");
    users[username] = hashed;
  } else {
    if (users[username] !== hashed) return showMsg("Invalid credentials");
  }

  localStorage.setItem("users", JSON.stringify(users));
  localStorage.setItem("loggedInUser", username);
  hideAuthUI();
}

function toggleAuthForm(mode) {
  document.getElementById("authForm").style.display = "block";
  document.getElementById("authTitle").textContent = mode === "signup" ? "Signup" : "Login";
  document.getElementById("authForm").setAttribute("data-mode", mode);
  document.getElementById("authMessage").textContent = '';
}

function showMsg(msg) {
  document.getElementById("authMessage").textContent = msg;
}

function hideAuthUI() {
  document.getElementById("authForm").style.display = "none";
  document.getElementById("loginBtn").style.display = "none";
  document.getElementById("signupBtn").style.display = "none";
  document.getElementById("logoutBtn").style.display = "inline-block";
}

function logout() {
  localStorage.removeItem("loggedInUser");
  document.getElementById("loginBtn").style.display = "inline-block";
  document.getElementById("signupBtn").style.display = "inline-block";
  document.getElementById("logoutBtn").style.display = "none";
}

window.onload = () => {
  if (localStorage.getItem("loggedInUser")) hideAuthUI();
  loadGrouped("anim3", "anim3-videos");
  loadGrouped("donghua", "donghua-videos");
  loadGrouped("news", "news-videos");
};
</script>
</body>
</html>
